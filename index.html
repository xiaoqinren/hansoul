<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INKUL | Discover Your Chinese Identity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;900&family=ZCOOL+XiaoWei&family=Long+Cang&display=swap');
        
        body {
            background-color: #f9f8f4;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            font-family: 'Noto Serif SC', serif;
        }
        .ink-title { font-family: 'Ma Shan Zheng', cursive; }
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-ink {
            background: #1a1a1a;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
        }
        .btn-ink:hover { background: #b91c1c; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(185, 28, 28, 0.2); }
        .btn-ink:active { background: #b91c1c; }
        .btn-ink:disabled { background: #7f1d1d; color: rgba(255,255,255,0.95); cursor: not-allowed; }
        /* ‰∏≠ÂõΩÈ£éÂêçÁâáÔºöÂÆ£Á∫∏ÁôΩ + Â¢®Ëâ≤Â≠ó + Êú±Á†ÇÁ∫¢ÁÇπÁºÄÔºå‰∏ãËΩΩÂõæÁâá‰πü‰∏ÄËá¥ */
        .name-card-wrap {
            background: #faf8f5;
            border: 2px solid #8b4513;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.12);
            width: 100%;
            max-width: 320px;
            min-height: 200px;
            margin-left: auto;
            margin-right: auto;
            padding: 24px 20px;
            position: relative;
            box-sizing: border-box;
        }
        .name-card-wrap::before, .name-card-wrap::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border: 2px solid #8b4513;
            top: 8px;
        }
        .name-card-wrap::before { left: 8px; }
        .name-card-wrap::after { right: 8px; border-left: none; }
        .name-card-name { font-family: 'Ma Shan Zheng', 'KaiTi', 'STKaiti', 'SimKai', 'Noto Serif SC', serif; font-size: 2.5rem; color: #2c1810; line-height: 1.4; text-align: center; margin-bottom: 12px; }
        .name-card-divider { width: 60px; height: 2px; background: #b91c1c; margin: 12px auto; }
        .name-card-brand { font-family: 'Noto Serif SC', serif; font-size: 0.75rem; color: #8b4513; letter-spacing: 0.2em; text-align: center; margin-top: 10px; }
        .name-card-slogan { font-size: 0.5rem; color: #a0522d; opacity: 0.9; text-align: center; margin-top: 2px; font-style: italic; }
        .name-card-url { font-size: 0.45rem; color: #8b7355; text-align: center; margin-top: 4px; letter-spacing: 0.05em; }
        .name-card-latin { color: #4a3728 !important; }
        .name-card-zodiac { position: absolute; font-size: 0.85rem; opacity: 0.88; }
        .name-card-zodiac-tl { top: 6px; left: 8px; }
        .name-card-zodiac-tr { top: 6px; right: 8px; }
        .name-card-zodiac-bl { bottom: 6px; left: 8px; }
        .name-card-zodiac-br { bottom: 6px; right: 8px; }
        /* Âç∞Á´†Ôºö15mm ÊñπÂΩ¢ÔºåÁôΩÂ∫ïÁ∫¢Â≠óÔºåÂêçÂ≠óÊ®™ÊéíÔºåÊú¨ÂêçÂú®‰∏ãÂ∞èÂ≠óÔºåÊ†áÊ≥®Â∞∫ÂØ∏„ÄÇ‰∏âÁßçÈ£éÊ†ºÁî®‰∏âÁßç‰∏ªÊµÅ‰∏≠ÊñáÂ≠ó‰ΩìÂå∫ÂàÜ */
        .seal-preview {
            width: 56px; height: 56px;
            background: #fff;
            color: #b91c1c;
            border: 2px solid #b91c1c;
            border-radius: 2px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            box-sizing: border-box;
        }
        /* Âç∞Á´†‰∏âÊ¨æÂ≠ó‰ΩìÔºöÁî® Web Â≠ó‰Ωì‰øùËØÅÊâãÊú∫/Ë∑®Âπ≥Âè∞ÊòæÁ§∫‰∏çÂêåÔºàÁ≥ªÁªüÂ≠ó‰Ωì‰ªÖ‰Ωú fallbackÔºâ */
        .seal-preview.seal-font-kai { font-family: 'ZCOOL XiaoWei', 'KaiTi', 'STKaiti', 'Ê•∑‰Ωì', serif; }
        .seal-preview.seal-font-song { font-family: 'Noto Serif SC', 'SimSun', 'ÂÆã‰Ωì', 'STSong', serif; }
        .seal-preview.seal-font-li { font-family: 'Long Cang', 'LiSu', 'Èö∂‰π¶', 'STLiti', cursive; }
        .seal-preview .seal-name-row { font-size: 0.95rem; line-height: 1.2; white-space: nowrap; }
        .seal-preview .seal-latin-row { font-size: 0.5rem; color: #991b1b; margin-top: 2px; font-weight: normal; }
        .seal-size-outer { font-size: 0.4rem; color: #9ca3af; margin-top: 2px; display: block; text-align: center; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-3 sm:p-4">
    <div class="max-w-md w-full glass rounded-3xl shadow-2xl overflow-hidden border-t-8 border-red-700 p-5 sm:p-6">
        <header class="text-center mb-5">
            <h1 class="ink-title text-5xl sm:text-6xl text-red-700 mb-1">Âç∞Âàª</h1>
            <h2 class="text-xl sm:text-2xl font-black tracking-widest text-gray-800">INKUL</h2>
            <p class="text-gray-500 italic mt-1 text-sm">Every soul deserves a Chinese name.</p>
        </header>

        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase tracking-wider">Your name</label>
                <input type="text" id="customerName" placeholder="e.g. John Smith"
                    class="w-full px-3 py-2.5 rounded-lg border-2 border-gray-100 focus:border-red-700 focus:ring-0 outline-none bg-white/50 text-sm" />
                <label class="mt-2 block text-[11px] font-semibold text-gray-600">Birth date (optional)</label>
                <input type="date" id="birthDate"
                    class="mt-1 w-full px-3 py-2 rounded-lg border-2 border-gray-100 focus:border-red-700 focus:ring-0 outline-none bg-white/50 text-xs text-gray-700" />
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase tracking-wider">Tell us your story</label>
                <textarea id="userStory" rows="2" 
                    class="w-full px-3 py-2.5 rounded-lg border-2 border-gray-100 focus:border-red-700 focus:ring-0 transition-all outline-none resize-none bg-white/50 text-sm"
                    placeholder="E.g. I love the ocean, I am a brave explorer from London..."></textarea>
            </div>

            <button onclick="generateName()" id="btnText"
                class="btn-ink w-full py-3 rounded-xl text-white font-bold text-sm tracking-widest">
                REVEAL MY IDENTITY
            </button>
            <p id="generateHint" class="hidden mt-1.5 text-center text-xs text-amber-700">
                The ancients are weaving your name. <span id="generateCountdown" class="font-bold">60s</span>
            </p>

            <div id="resultArea" class="hidden mt-5 p-4 bg-red-50 rounded-2xl border-l-4 border-red-700 animate-fade-in">
                <!-- ÂêçÁâáÔºö‰∏éÁªìÊûúÂêåÊó∂ÂëàÁé∞ÔºåÊîæÂú®ÊúÄ‰∏äÊñπ -->
                <div id="nameCardSection" class="hidden flex flex-col items-center mb-4">
                    <p class="text-xs text-gray-500 mb-1.5 text-center w-full">Your Chinese-style name card</p>
                    <div id="nameCardEl" class="name-card-wrap scale-90 origin-top">
                        <div id="nameCardName" class="name-card-name"></div>
                        <div id="nameCardLatin" class="name-card-latin text-center text-gray-600 text-sm mt-1"></div>
                        <div class="name-card-divider"></div>
                        <p class="name-card-brand">Âç∞Âàª INKUL</p>
                        <p class="name-card-slogan">Every soul deserves a Chinese name.</p>
                        <p class="name-card-url">https://inkul.name</p>
                        <div id="nameCardZodiacTL" class="name-card-zodiac name-card-zodiac-tl"></div>
                        <div id="nameCardZodiacTR" class="name-card-zodiac name-card-zodiac-tr"></div>
                        <div id="nameCardZodiacBL" class="name-card-zodiac name-card-zodiac-bl"></div>
                        <div id="nameCardZodiacBR" class="name-card-zodiac name-card-zodiac-br"></div>
                    </div>
                    <button type="button" onclick="downloadNameCard()" class="mt-1 w-full py-1.5 rounded-lg border-2 border-red-700 text-red-700 font-bold text-xs hover:bg-red-50 transition-colors">
                        Download as image
                    </button>
                    <!-- Á¨îÈ°∫‰∏éËØªÈü≥ÔºöÁ¥ßÊé•Âú® download ‰∏ãÊñπ -->
                    <div id="videoSection" class="hidden mt-3 w-full">
                        <div class="p-3 rounded-xl border-2 border-amber-200 bg-amber-50/80">
                            <p class="text-xs font-bold text-amber-900 mb-0.5">Stroke-order & pronunciation</p>
                            <p class="text-xs text-amber-800 mb-2">$9.90</p>
                            <button type="button" id="btnPurchaseVideo" onclick="purchaseVideo()" class="btn-ink w-full py-2.5 rounded-xl text-white font-bold text-xs tracking-widest">
                                PURCHASE VIDEO
                            </button>
                        </div>
                    </div>
                </div>
                <h3 class="text-red-800 font-bold mb-1.5 text-sm flex items-center">
                    <span class="mr-2 italic">Your Chinese Soul Name:</span>
                </h3>
                <div id="resultText" class="text-gray-800 leading-relaxed text-base"></div>
                <!-- Âç∞Á´†ÈÄâÊ¨æ + ËßÜÈ¢ë -->
                <div class="mt-3 space-y-3">
                <div id="sealSection" class="hidden">
                    <div class="p-3 rounded-xl border-2 border-red-100 bg-white/80">
                        <p class="text-xs font-bold text-gray-800 mb-1.5">Choose your seal design</p>
                        <p class="text-xs text-gray-500 mb-2">15mm square, we ship from China.</p>
                        <div id="sealChoices" class="grid grid-cols-3 gap-2 mb-3">
                            <button type="button" data-seal="0" class="seal-option border-2 border-transparent rounded-lg p-1.5 hover:border-red-500 transition-all flex flex-col items-center" onclick="selectSeal(0)">
                                <div class="seal-preview seal-font-kai"></div>
                                <span class="text-[10px] mt-1 block text-center">A Ê•∑‰Ωì</span>
                                <span class="seal-size-outer">15√ó15mm</span>
                            </button>
                            <button type="button" data-seal="1" class="seal-option border-2 border-transparent rounded-lg p-1.5 hover:border-red-500 transition-all flex flex-col items-center" onclick="selectSeal(1)">
                                <div class="seal-preview seal-font-song"></div>
                                <span class="text-[10px] mt-1 block text-center">B ÂÆã‰Ωì</span>
                                <span class="seal-size-outer">15√ó15mm</span>
                            </button>
                            <button type="button" data-seal="2" class="seal-option border-2 border-transparent rounded-lg p-1.5 hover:border-red-500 transition-all flex flex-col items-center" onclick="selectSeal(2)">
                                <div class="seal-preview seal-font-li"></div>
                                <span class="text-[10px] mt-1 block text-center">C Èö∂‰π¶</span>
                                <span class="seal-size-outer">15√ó15mm</span>
                            </button>
                        </div>
                        <p id="sealSelectedHint" class="text-xs text-amber-700 mb-2 hidden">Selected: Style <span id="sealSelectedLabel"></span></p>
                        <button type="button" id="btnSealCheckout" onclick="openSealCheckout()" class="btn-ink w-full py-2.5 rounded-xl text-white font-bold text-xs tracking-widest" disabled>
                            PROCEED TO CHECKOUT
                        </button>
                    </div>
                </div>
                </div>
                <div id="sealAddressModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 hidden">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Shipping address</h3>
                        <form id="sealAddressForm" onsubmit="submitSealOrder(event)">
                            <input type="text" name="fullName" placeholder="Full name *" required class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="email" name="email" placeholder="Email *" required class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="country" placeholder="Country *" required class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="addressLine1" placeholder="Address line 1 *" required class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="addressLine2" placeholder="Address line 2" class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="city" placeholder="City *" required class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="state" placeholder="State / Province" class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="postalCode" placeholder="Postal code *" required class="w-full px-3 py-2 border rounded-lg mb-2" />
                            <input type="text" name="phone" placeholder="Phone *" required class="w-full px-3 py-2 border rounded-lg mb-4" />
                            <p class="text-sm text-gray-600 mb-3">Seal + shipping: <strong class="text-red-700">$29.90</strong></p>
                            <div class="flex gap-2">
                                <button type="button" onclick="closeSealCheckout()" class="flex-1 py-2 border rounded-lg font-bold">Cancel</button>
                                <button type="submit" id="btnSubmitSealOrder" class="flex-1 py-2 rounded-lg bg-red-700 text-white font-bold">Pay & order</button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- ÂèñÂêçÂêéÁöÑÂÆåÊï¥ÊóÖÁ®ãÔºöÂèØÊäòÂè† -->
                <div id="journeyArea" class="mt-4 pt-4 border-t border-red-200">
                    <button type="button" id="journeyToggle" onclick="toggleJourney()" class="w-full flex items-center justify-between text-left text-xs font-bold text-gray-700 uppercase tracking-wider py-1 rounded hover:bg-red-50/50 transition-colors">
                        <span>Your journey with INKUL</span>
                        <span id="journeyChevron" class="text-red-600 transition-transform">‚ñº</span>
                    </button>
                    <ol id="journeyList" class="mt-2 space-y-2 text-xs text-gray-600 hidden">
                        <li class="flex items-start gap-2"><span class="flex-shrink-0 w-4 h-4 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-[10px] font-bold">1</span><span><strong class="text-gray-800">Name card</strong> ‚Äî Chinese-style name card.</span></li>
                        <li class="flex items-start gap-2"><span class="flex-shrink-0 w-4 h-4 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-[10px] font-bold">2</span><span><strong class="text-gray-800">Stroke-order video</strong> <em class="text-red-600">(Paid)</em></span></li>
                        <li class="flex items-start gap-2"><span class="flex-shrink-0 w-4 h-4 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-[10px] font-bold">3</span><span><strong class="text-gray-800">Seal</strong> ‚Äî We ship from China.</span></li>
                        <li class="flex items-start gap-2"><span class="flex-shrink-0 w-4 h-4 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-[10px] font-bold">4</span><span><strong class="text-gray-800">Physical kit</strong> ‚Äî Optional.</span></li>
                    </ol>
                </div>
            </div>
        </div>

        <footer class="mt-6 text-center text-xs text-gray-400 tracking-widest uppercase">
            &copy; 2026 INKUL ¬∑ Inheriting Culture
        </footer>
    </div>

    <!-- Á¨îÈ°∫ + ËØªÈü≥ ÂºπÂ±Ç -->
    <div id="videoModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Stroke order & pronunciation</h3>
                <button type="button" onclick="closeVideoModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <p id="videoModalName" class="text-center text-red-700 font-bold text-xl mb-0"></p>
            <p id="videoModalPinyin" class="text-center text-gray-500 text-sm mt-1 mb-2"></p>
            <div id="strokeOrderContainer" class="flex flex-wrap justify-center gap-4 my-6 min-h-[120px]"></div>
            <div class="flex justify-center gap-2">
                <button type="button" onclick="playStrokeOrder()" class="px-4 py-2 rounded-lg bg-red-700 text-white text-sm font-bold">Play stroke order</button>
                <button type="button" onclick="playPronunciation()" class="px-4 py-2 rounded-lg border-2 border-red-700 text-red-700 text-sm font-bold">Play pronunciation</button>
            </div>
        </div>
    </div>

    <script>
        async function generateName() {
            const story = document.getElementById('userStory').value;
            const btn = document.getElementById('btnText');
            const resultArea = document.getElementById('resultArea');
            const resultText = document.getElementById('resultText');
            if (!story) return alert("Please enter your story!");

            btn.innerText = "Consulting the Ancients...";
            btn.disabled = true;
            var hintEl = document.getElementById('generateHint');
            var countdownEl = document.getElementById('generateCountdown');
            hintEl.classList.remove('hidden');
            var sec = 60;
            countdownEl.textContent = sec + 's';
            var countdownTimer = setInterval(function() {
                sec--;
                if (sec >= 0) countdownEl.textContent = sec + 's';
                if (sec <= 0) clearInterval(countdownTimer);
            }, 1000);

            try {
                // ËØ∑Ê±Ç Vercel ÂêéÁ´ØÊé•Âè£ÔºåÈÅøÂºÄÊµèËßàÂô®Ë∑®ÂüüÊã¶Êà™
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: story })
                });
                const data = await response.json();
                if (data.text) {
                    resultText.innerText = data.text;
                } else {
                    resultText.innerText = "Error: " + (data.error || "Unknown response");
                }
                resultArea.classList.remove('hidden');
                if (data.text) {
                    document.getElementById('nameCardSection').classList.remove('hidden');
                    showNameCard();
                    document.getElementById('videoSection').classList.remove('hidden');
                    document.getElementById('sealSection').classList.remove('hidden');
                    window.currentChineseName = extractNameOnly(data.text);
                    renderSealPreviews(window.currentChineseName);
                }
            } catch (e) {
                resultText.innerText = "The connection is weak. Please try again.";
                resultArea.classList.remove('hidden');
            } finally {
                if (typeof countdownTimer !== 'undefined') clearInterval(countdownTimer);
                btn.innerText = "REVEAL MY IDENTITY";
                btn.disabled = false;
                document.getElementById('generateHint').classList.add('hidden');
            }
        }

        function extractNameOnly(fullText) {
            var s = fullText.trim();
            // ‰ºòÂÖàÂèñÊï¥ÊÆµÈáåÁöÑ‰∏≠ÊñáÂêçÔºà2ÔΩû6 ‰∏™Ê±âÂ≠óÔºâÔºåÈÅøÂÖçÊã¨Âè∑ÈáåÁöÑ‰∏≠ÊñáË¢´Âà†ÊéâÂêéÂè™Ââ©Ëã±Êñá
            var chineseMatch = s.match(/[\u4e00-\u9fff]{2,6}/);
            if (chineseMatch) return chineseMatch[0];
            // Ê≤°Êúâ‰∏≠ÊñáÊó∂ÂÜçÂèñÂÜíÂè∑ÂêéÊàñÁ¨¨‰∏ÄË°åÔºàÂèØËÉΩÊòØÁ∫ØÊãºÈü≥Ôºâ
            var afterColon = s.split(/[Ôºö:]/).pop().trim().replace(/\s+/g, ' ');
            var firstLine = afterColon.split(/[\n\r]/)[0].trim();
            return firstLine.slice(0, 8) || firstLine || s.slice(0, 8);
        }

        function showNameCard() {
            var fullText = document.getElementById('resultText').innerText.trim();
            if (!fullText) return;
            var nameOnly = extractNameOnly(fullText);
            var latin = document.getElementById('customerName').value.trim();
            document.getElementById('nameCardName').innerText = nameOnly;
            var latinEl = document.getElementById('nameCardLatin');
            latinEl.innerText = latin || '';
            latinEl.style.display = latin ? 'block' : 'none';

            // Ê†πÊçÆÂá∫ÁîüÂπ¥‰ªΩËÆ°ÁÆóÁîüËÇñÔºåÂú®ÂêçÁâáÂõõËßíÂ±ïÁ§∫ÂõæÊ°à
            var birth = document.getElementById('birthDate') ? document.getElementById('birthDate').value : '';
            var zodiacChar = '';
            if (birth && birth.length >= 4) {
                var year = parseInt(birth.slice(0, 4), 10);
                if (!isNaN(year)) {
                    var animals = ['Èº†','Áâõ','Ëôé','ÂÖî','Èæô','Ëõá','È©¨','Áæä','Áå¥','È∏°','Áãó','Áå™'];
                    var emojis =  ['üê≠','üêÆ','üêØ','üê∞','üê≤','üêç','üê¥','üêë','üêí','üêî','üê∂','üê∑'];
                    var idx = (year - 4) % 12;
                    if (idx < 0) idx += 12;
                    zodiacChar = emojis[idx] + ' ' + animals[idx];
                }
            }
            ['TL','TR','BL','BR'].forEach(function(pos) {
                var el = document.getElementById('nameCardZodiac' + pos);
                if (el) el.textContent = zodiacChar || '';
            });
        }

        function downloadNameCard() {
            var el = document.getElementById('nameCardEl');
            if (!el) return;
            if (typeof html2canvas === 'undefined') {
                alert('Download not available. Try again after the page loads.');
                return;
            }
            html2canvas(el, {
                scale: 2,
                useCORS: true,
                backgroundColor: null,
                logging: false
            }).then(function(canvas) {
                var link = document.createElement('a');
                link.download = 'inkul-name-card.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        var strokeWriters = [];
        function openVideoModal(name) {
            if (!name || !name.trim()) return;
            var modal = document.getElementById('videoModal');
            var container = document.getElementById('strokeOrderContainer');
            var nameEl = document.getElementById('videoModalName');
            var pinyinEl = document.getElementById('videoModalPinyin');
            nameEl.textContent = name;
            pinyinEl.textContent = toPinyin(name);
            container.innerHTML = '';
            strokeWriters = [];
            if (typeof HanziWriter !== 'undefined') {
                for (var i = 0; i < name.length; i++) {
                    var c = name[i];
                    if (!/[\u4e00-\u9fff]/.test(c)) continue;
                    var div = document.createElement('div');
                    div.id = 'stroke-char-' + i;
                    div.className = 'inline-block';
                    container.appendChild(div);
                    try {
                        var w = HanziWriter.create(div.id, c, {
                            width: 80,
                            height: 80,
                            padding: 5,
                            showOutline: true,
                            strokeAnimationSpeed: 1.2,
                            delayBetweenStrokes: 400
                        });
                        strokeWriters.push(w);
                    } catch (e) { console.warn('HanziWriter skip char:', c, e); }
                }
            }
            modal.classList.remove('hidden');
        }
        function closeVideoModal() {
            document.getElementById('videoModal').classList.add('hidden');
        }
        /* Â∏∏Áî®Ê±âÂ≠óÊãºÈü≥ÔºàÂ∏¶Â£∞Ë∞ÉÔºâÔºåÁî®‰∫éÂêçÂ≠ó‰∏ãÊñπÊ≥®Èü≥ÔºõÁº∫Â≠óÂàôÊòæÁ§∫ÂéüÂ≠ó */
        var PINYIN_MAP = {
            'Êùé':'l«ê','Áéã':'w√°ng','Âº†':'zhƒÅng','Âàò':'li√∫','Èôà':'ch√©n','Êù®':'y√°ng','ÈªÑ':'hu√°ng','Ëµµ':'zh√†o','Âë®':'zh≈çu','Âê¥':'w√∫',
            'Âæê':'x√∫','Â≠ô':'s≈´n','È©¨':'m«é','Êú±':'zh≈´','ËÉ°':'h√∫','ÈÉ≠':'gu≈ç','‰Ωï':'h√©','È´ò':'gƒÅo','Êûó':'l√≠n','ÁΩó':'lu√≥',
            'ÈÉë':'zh√®ng','Ê¢Å':'li√°ng','Ë∞¢':'xi√®','ÂÆã':'s√≤ng','Âîê':'t√°ng','ËÆ∏':'x«î','Èü©':'h√°n','ÂÜØ':'f√©ng','ÈÇì':'d√®ng','Êõπ':'c√°o',
            'ÂΩ≠':'p√©ng','Êõæ':'zƒìng','ËÇñ':'xiƒÅo','Áî∞':'ti√°n','Ëë£':'d«íng','ÊΩò':'pƒÅn','Ë¢Å':'yu√°n','Ëî°':'c√†i','Ëíã':'ji«éng','‰Ωô':'y√∫',
            '‰∫é':'y√∫','Êùú':'d√π','Âè∂':'y√®','Á®ã':'ch√©ng','Ëãè':'s≈´','È≠è':'w√®i','Âêï':'l«ö','‰∏Å':'dƒ´ng','‰ªª':'r√©n','Ê≤à':'shƒõn',
            'Âßö':'y√°o','Âç¢':'l√∫','Âßú':'jiƒÅng','Â¥î':'cuƒ´','Èíü':'zh≈çng','Ë∞≠':'t√°n','ÈôÜ':'l√π','Ê±™':'wƒÅng','ËåÉ':'f√†n','Èáë':'jƒ´n',
            'Áü≥':'sh√≠','Âªñ':'li√†o','Ë¥æ':'ji«é','Â§è':'xi√†','Èü¶':'w√©i','ÂÇÖ':'f√π','Êñπ':'fƒÅng','ÁôΩ':'b√°i','ÈÇπ':'z≈çu','Â≠ü':'m√®ng',
            'ÁÜä':'xi√≥ng','Áß¶':'q√≠n','ÈÇ±':'qi≈´','Ê±ü':'jiƒÅng','Â∞π':'y«ên','Ëñõ':'xuƒì','Èó´':'y√°n','ÊÆµ':'du√†n','Èõ∑':'l√©i','‰æØ':'h√≥u',
            'Èæô':'l√≥ng','Âè≤':'sh«ê','Èô∂':'t√°o','Èªé':'l√≠','Ë¥∫':'h√®','È°æ':'g√π','ÊØõ':'m√°o','ÈÉù':'h«éo','Èæö':'g≈çng','ÈÇµ':'sh√†o',
            '‰∏á':'w√†n','Èí±':'qi√°n','‰∏•':'y√°n','Ê≠¶':'w«î','Êà¥':'d√†i','Ëé´':'m√≤','Â≠î':'k«íng','Âêë':'xi√†ng','Ê±§':'tƒÅng',
            '‰ºü':'wƒõi','Ëä≥':'fƒÅng','Â®ú':'n√†','Êïè':'m«ên','Èùô':'j√¨ng','‰∏Ω':'l√¨','Âº∫':'qi√°ng','Á£ä':'lƒõi','ÂÜõ':'j≈´n','Ê¥ã':'y√°ng',
            'Âãá':'y«íng','Ëâ≥':'y√†n','Êù∞':'ji√©','Â®ü':'juƒÅn','Ê∂õ':'tƒÅo','Êòé':'m√≠ng','Ë∂Ö':'chƒÅo','ÁßÄ':'xi√π','Ëã±':'yƒ´ng','Âçé':'hu√°',
            'Êñá':'w√©n','Áéâ':'y√π','ÂÖ∞':'l√°n','Á∫¢':'h√≥ng','Èúû':'xi√°','Âπ≥':'p√≠ng','Âª∫':'ji√†n','ÂõΩ':'gu√≥','È£û':'fƒìi','Ê≥¢':'b≈ç',
            'Êñå':'bƒ´n','Ëæâ':'huƒ´','Â≥∞':'fƒìng','Á£ä':'lƒõi','Èò≥':'y√°ng','Êµ©':'h√†o','ÂÆá':'y«î','ËΩ©':'xuƒÅn','Áùø':'ru√¨','ÊÄù':'sƒ´',
            'Ê¨£':'xƒ´n','ÊÄ°':'y√≠','Áê≥':'l√≠n','Â©∑':'t√≠ng','Èõ™':'xuƒõ','Ê¢Ö':'m√©i','‰∫ë':'y√∫n','Êúà':'yu√®','Êòü':'xƒ´ng','Êô®':'ch√©n',
            'Êôì':'xi«éo','Ê¢¶':'m√®ng','ËØó':'shƒ´','Èõ®':'y«î','Âòâ':'jiƒÅ','‰øä':'j√πn','Âçö':'b√≥','Â≠ê':'z«ê','Ê¢ì':'z«ê','Ê∂µ':'h√°n',
            'Ëê±':'xuƒÅn','Ëã•':'ru√≤','Ëä∑':'zh«ê','ÁÜô':'xƒ´','ÂÆâ':'ƒÅn','ÂÆÅ':'n√≠ng','‰πê':'l√®','ÊÇ¶':'yu√®','ÂøÉ':'xƒ´n','Áà±':'√†i'
        };
        function toPinyin(name) {
            if (!name) return '';
            var out = [];
            for (var i = 0; i < name.length; i++) {
                var c = name[i];
                out.push(PINYIN_MAP[c] || c);
            }
            return out.join(' ');
        }
        function playStrokeOrder() {
            if (!strokeWriters.length) return;
            var i = 0;
            function next() {
                if (i >= strokeWriters.length) return;
                strokeWriters[i].animateCharacter().then(function() { i++; next(); });
            }
            next();
        }
        function playPronunciation() {
            var name = document.getElementById('videoModalName').textContent;
            if (!name) return;
            if (!window.speechSynthesis) { alert('Pronunciation not supported in this browser.'); return; }
            var u = new SpeechSynthesisUtterance(name);
            u.lang = 'zh-CN';
            u.rate = 0.9;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }
        async function purchaseVideo() {
            var name = window.currentChineseName || extractNameOnly(document.getElementById('resultText').innerText.trim());
            if (!name) return alert('Get your Chinese name first.');
            var btn = document.getElementById('btnPurchaseVideo');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            try {
                var res = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                var data = await res.json();
                if (data.url) {
                    window.location.href = data.url;
                    return;
                }
            } catch (e) { console.warn(e); }
            btn.disabled = false;
            btn.textContent = 'PURCHASE VIDEO';
            openVideoModal(name);
        }
        var selectedSealIndex = -1;
        function renderSealPreviews(name) {
            if (!name) return;
            var latin = document.getElementById('customerName').value.trim();
            var previews = document.querySelectorAll('.seal-preview');
            for (var i = 0; i < previews.length; i++) {
                var html = '<span class="seal-name-row">' + name + '</span>';
                if (latin) html += '<span class="seal-latin-row">' + latin + '</span>';
                previews[i].innerHTML = html;
            }
        }
        function toggleJourney() {
            var list = document.getElementById('journeyList');
            var chevron = document.getElementById('journeyChevron');
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                if (chevron) chevron.style.transform = 'rotate(180deg)';
            } else {
                list.classList.add('hidden');
                if (chevron) chevron.style.transform = '';
            }
        }
        function selectSeal(i) {
            selectedSealIndex = i;
            document.querySelectorAll('.seal-option').forEach(function(el) { el.classList.remove('border-red-600'); el.classList.add('border-transparent'); });
            var chosen = document.querySelector('.seal-option[data-seal="' + i + '"]');
            if (chosen) { chosen.classList.remove('border-transparent'); chosen.classList.add('border-red-600'); }
            document.getElementById('btnSealCheckout').disabled = false;
            var labels = ['A', 'B', 'C'];
            document.getElementById('sealSelectedLabel').textContent = labels[i];
            document.getElementById('sealSelectedHint').classList.remove('hidden');
        }
        function openSealCheckout() {
            if (selectedSealIndex < 0) return;
            document.getElementById('sealAddressModal').classList.remove('hidden');
        }
        function closeSealCheckout() {
            document.getElementById('sealAddressModal').classList.add('hidden');
        }
        async function submitSealOrder(e) {
            e.preventDefault();
            var form = document.getElementById('sealAddressForm');
            var fd = new FormData(form);
            var address = {
                fullName: fd.get('fullName'),
                email: fd.get('email'),
                country: fd.get('country'),
                addressLine1: fd.get('addressLine1'),
                addressLine2: fd.get('addressLine2') || '',
                city: fd.get('city'),
                state: fd.get('state') || '',
                postalCode: fd.get('postalCode'),
                phone: fd.get('phone')
            };
            var name = window.currentChineseName;
            if (!name) return alert('Missing name.');
            var btn = document.getElementById('btnSubmitSealOrder');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            try {
                var res = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, sealIndex: selectedSealIndex, address: address })
                });
                var data = await res.json();
                if (data.paymentUrl) {
                    window.location.href = data.paymentUrl;
                    return;
                }
                if (data.orderId && !data.paymentUrl) {
                    alert('Order ' + data.orderId + ' recorded. Payment is not configured yet; we\'ll contact you.');
                    closeSealCheckout();
                    return;
                }
                alert(data.error || 'Could not create order.');
            } catch (err) {
                alert('Network error. Try again.');
            }
            btn.disabled = false;
            btn.textContent = 'Pay & order';
        }
        document.addEventListener('DOMContentLoaded', function() {
            var customerInput = document.getElementById('customerName');
            if (customerInput) customerInput.addEventListener('input', function() {
                if (window.currentChineseName) renderSealPreviews(window.currentChineseName);
            });
            var params = new URLSearchParams(window.location.search);
            if (params.get('paid') === '1' && params.get('name')) {
                var name = decodeURIComponent(params.get('name'));
                openVideoModal(name);
            }
            if (params.get('paid') === '1' && params.get('order_id')) {
                var orderId = params.get('order_id');
                var thankYou = document.createElement('div');
                thankYou.className = 'p-4 rounded-xl bg-green-50 border border-green-200 text-green-800 text-sm mb-4';
                thankYou.innerHTML = '<strong>Thank you!</strong> We\'ve received your order (' + orderId + ') and will ship your seal soon. We\'ll email you the tracking number.';
                var card = document.querySelector('.glass');
                if (card) card.insertBefore(thankYou, card.querySelector('.space-y-6'));
            }
        });
    </script>
</body>
</html>
